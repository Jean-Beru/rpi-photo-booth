<!DOCTYPE html>
<html>
    <head>
        <title>{{#__}}title{{/__}}</title>
        <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />
        <script src="/socket.io/socket.io.js"></script>
        <script src="/assets/libs/jquery/dist/jquery.min.js"></script>
    </head>
    <body>
        <main>
            <div id="webcam">
                <img id="stream" />
                <div class="wrapper">
                    <div id="countdown">
                        <div class="timer">
                            <div class="hand"><span></span></div>
                            <div class="hand"><span></span></div>
                        </div>
                        <div id="countdown_text"></div>
                    </div>
                </div>
            </div>
            <div class="last">
                <ul id="last_caption">
                    {{#last}}
                        <li><img src="/photos/{{.}}"></li>
                    {{/last}}
                </ul>
            </div>
        </main>

        <script>
            var socket = io();
            socket.on('stream', function(data) {
                var stream = $('#stream');
                stream.attr('src', '/stream/'+data.file + '?_ts=' + (new Date().getTime()));

                var webcam = $('#webcam');
                webcam.height(Math.max(webcam.height(), stream.height()));
                webcam.width(Math.max(webcam.width(), stream.width()));
            });

            socket.on('capture', function(data) {
                var list = $('#last_caption');
                if (list.find('li').length >= 12) {
                    list.find('li:last').remove();
                }
                list.prepend(
                    $('<li>').append($('<img>').attr('src', '/photos/' + data.file))
                );

                var preview = $('<div>').attr('id', 'preview')
                    .appendTo('body')
                    .append($('<img>').attr('src', '/photos/' + data.file));
                setTimeout(
                    function() {
                        preview.fadeOut(1000, function() {$(this).remove();});
                    },
                    5000
                )
            });

            var countdown, interval;
            function showCountdown() {
                $('#countdown').addClass('start');
                if (0 === countdown) {
                    $('#countdown').removeClass('start');
                    clearInterval(interval);
                    socket.emit('capture');
                    $('<div>').attr('id', 'overlay').appendTo('body').fadeOut(500, function() {$(this).remove();});
                } else {
                    $('#countdown_text').text(countdown);
                }
                countdown--;
            }

            $(document).on('click contextmenu', function() {
                if ($('#countdown').hasClass('start')) {
                    return false;
                }
                countdown = 5;
                showCountdown();
                interval = setInterval(showCountdown, 1000);
                return false;
            });
        </script>
    </body>
</html>
