<!DOCTYPE html>
<html>
    <head>
        <title>{{#__}}title{{/__}}</title>
        <link rel="stylesheet" type="text/css" href="/css/style.css" />
        <script src="/socket.io/socket.io.js"></script>
        <script src="js/libs/jquery/dist/jquery.min.js"></script>
    </head>
    <body>
        <div id="webcam">
            <img id="stream" />
            <div class="wrapper">
                <div id="countdown">
                    <div class="timer">
                        <div class="hand"><span></span></div>
                        <div class="hand"><span></span></div>
                    </div>
                    <div id="countdown_text"></div>
                </div>
            </div>
        </div>
        <div class="last">
            <ul id="last_caption">
                {{#last}}
                    <li><img src="/photos/{{.}}"></li>
                {{/last}}
            </ul>
        </div>

        <div class="action">
            <button id="shot">{{#__}}action{{/__}}</button>
        </div>

        <script>
            var socket = io();
            socket.on('stream', function(data) {
                var stream = document.getElementById('stream');
                stream.src = 'data:image/jpeg;base64,' + data.stream;

                var webcam = document.getElementById('webcam');
                webcam.style.height = Math.max(+webcam.style.height, stream.offsetHeight) + 'px';
                webcam.style.width = Math.max(+webcam.style.width, stream.offsetWidth) + 'px';
            });

            socket.on('capture', function(data) {
                var child = '<li><img src="/photos/' + data.file + '"></li>';
                var list = document.getElementById('last_caption');
                if (0 === list.children.length) {
                    list.appendChild(child);
                } else {
                    list.removeChild(list.children[11]);
                    list.insertBefore(child)
                }
            });

            var countdown, interval;
            function showCountdown() {
                document.getElementById('countdown').className = 'start';
                if (0 === countdown) {
                    document.getElementById('countdown').className = '';
                    clearInterval(interval);
                    socket.emit('capture');
                } else {
                    document.getElementById('countdown_text').innerHTML = countdown;
                }
                countdown--;
            }

            document.getElementById('shot').onclick = function() {
                countdown = 5;
                showCountdown();
                interval = setInterval(showCountdown, 1000);
            };
        </script>
    </body>
</html>
